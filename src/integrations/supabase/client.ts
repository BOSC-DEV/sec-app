
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { sanitizeInput } from '@/utils/securityUtils';

const SUPABASE_URL = "https://mfirlsuuxpvgwaxymjor.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1maXJsc3V1eHB2Z3dheHltam9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyNDIyNjQsImV4cCI6MjA1ODgxODI2NH0.NCYmYYwlpwGieEd3VwrnWCKsva6Wl6Tw1ouTBmfSO-I";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    storageKey: 'supabase-auth',
    detectSessionInUrl: false, // Disable automatic detection of OAuth redirects
  },
  global: {
    headers: {
      'Content-Type': 'application/json',
      'X-Client-Info': 'sec-community-app',
    },
  },
  db: {
    schema: 'public',
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});

// Helper function to secure fetch requests to Supabase
export const secureFetch = async (url: string, options: RequestInit = {}) => {
  // Sanitize URL to prevent header injection
  const sanitizedUrl = sanitizeInput(url);
  
  // Apply default security headers
  const secureOptions = {
    ...options,
    headers: {
      ...options.headers,
      'Content-Security-Policy': "default-src 'self'",
      'X-Content-Type-Options': 'nosniff',
      'X-Frame-Options': 'DENY',
      'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
      'Referrer-Policy': 'strict-origin-when-cross-origin'
    },
  };
  
  return fetch(sanitizedUrl, secureOptions);
};

// Wallet authentication function for Supabase
export const authenticateWallet = async (
  walletAddress: string, 
  signedMessage: string,
  message: string
): Promise<boolean> => {
  if (!walletAddress || !signedMessage) {
    console.error("Missing required parameters for wallet authentication");
    return false;
  }

  try {
    console.log("Authenticating wallet:", walletAddress);
    
    // First check if a user exists with this wallet address
    const { data: existingUser, error: userCheckError } = await supabase
      .from('profiles')
      .select('*')
      .eq('wallet_address', walletAddress)
      .maybeSingle();
      
    if (userCheckError) {
      console.error("Error checking for existing user:", userCheckError);
    }
    
    // Instead of using email+password, use signInWithOtp with phone
    // This bypasses email validation since we're using the phone field
    // which doesn't validate the format like email does
    const { data, error } = await supabase.auth.signInWithOtp({
      phone: walletAddress,
    });

    if (error) {
      console.log("Sign in failed, trying sign up:", error.message);
      
      // If sign in fails, try sign up with phone
      const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
        phone: walletAddress,
        password: signedMessage.slice(0, 20), // Using part of signature as password
        options: {
          data: {
            wallet_address: walletAddress,
          }
        }
      });

      if (signUpError) {
        console.error("Error in wallet signup:", signUpError);
        return false;
      }
      
      console.log("User signed up successfully");
      
      // If the user didn't exist in profiles, we need to create a profile
      if (!existingUser) {
        // Create a default profile for the new user
        const { error: profileError } = await supabase
          .from('profiles')
          .insert({
            id: crypto.randomUUID(),
            wallet_address: walletAddress,
            display_name: `User ${walletAddress.substring(0, 6)}`,
            username: `user_${Date.now().toString(36)}`,
            created_at: new Date().toISOString()
          });
          
        if (profileError) {
          console.error("Error creating profile:", profileError);
        } else {
          console.log("Created new profile for wallet");
        }
      }
    } else {
      console.log("User signed in successfully");
    }

    return true;
  } catch (error) {
    console.error("Error in wallet authentication:", error);
    return false;
  }
};

// Helper function to safely insert data with RLS validation
export const safeInsert = async <T>(
  table: keyof Database['public']['Tables'],
  data: any,
  options?: { returning?: 'minimal' | 'representation' }
) => {
  // Clone data to avoid modifying original
  const sanitizedData = { ...data };
  
  // Sanitize all string fields to prevent XSS and SQL injection
  Object.keys(sanitizedData).forEach(key => {
    if (typeof sanitizedData[key] === 'string') {
      sanitizedData[key] = sanitizeInput(sanitizedData[key]);
    }
  });
  
  // Insert the data with returning option
  const result = supabase
    .from(table)
    .insert(sanitizedData);
    
  if (options?.returning) {
    return result.select();
  }
  
  return result;
};
